# üìã PLAN D'IMPL√âMENTATION AVA - DIVINE & CONCRET

> **Objectif** : Transformer AVA en une app concr√®te, fluide et intuitive avec login personnalis√© et onboarding ultra-optimis√©

---

## üéØ VISION PRODUIT

**AVA** = R√©ceptionniste IA pour TPE/PME/Ind√©pendants  
**Promesse** : Remplacer le standard t√©l√©phonique, automatiser RDV, g√©rer SAV client  
**Diff√©renciation** : "Vapi is an API. AVA is your receptionist."

---

## üèóÔ∏è ARCHITECTURE ACTUELLE (Ce qu'on a d√©j√†)

### ‚úÖ Backend (FastAPI + SQLAlchemy)
- **Database** : SQLite (dev), PostgreSQL (prod)
- **Auth** : Pas encore impl√©ment√© (TODO)
- **API** : Routes pour calls, analytics, AVA profiles
- **Int√©grations** : Vapi.ai configur√©, Twilio setup partiel

### ‚úÖ Frontend (Next.js 14 + TypeScript)
- **Database** : Prisma avec schema complet
  - Models : `User`, `Org`, `OrgUser`, `Ava`, `PhoneNumber`, `Call`, `Integration`, `PlanSubscription`
  - User : `email`, `name`, `locale`, `twoFAEnabled`
- **Auth UI** : Composant `SignInForm` avec magic link + OAuth (Google/Microsoft)
- **Onboarding** : Dossier vide (`/app/onboarding/`)
- **Int√©grations** : 
  - Vapi SDK client (`lib/vapi/client.ts`)
  - Twilio client (`lib/twilio.ts`)

---

## üöÄ CE QU'ON VA CONSTRUIRE

### 1Ô∏è‚É£ **SYST√àME D'AUTHENTIFICATION COMPLET**

#### A. Page de Login (`/login`)
```typescript
// Fonctionnalit√©s
- Login avec EMAIL ou NUM√âRO DE T√âL√âPHONE
- Option 1 : Magic Link (email)
- Option 2 : Password (pour les 2)
- Option 3 : OAuth (Google/Microsoft)
- "Remember me" checkbox
- Validation en temps r√©el
- Messages d'erreur clairs
```

**User Flow Login** :
```
1. User entre email OU phone number
2. Syst√®me d√©tecte le format (email vs phone)
3. Options propos√©es selon le format :
   - Email ‚Üí Magic Link OU Password
   - Phone ‚Üí SMS code OU Password
4. User choisit m√©thode
5. Validation et redirection vers /onboarding (premi√®re connexion) OU /dashboard
```

**Impl√©mentation** :
- Fichier : `/webapp/app/(public)/[locale]/(auth)/login/page.tsx`
- Composant : `/webapp/components/auth/login-form.tsx`
- Backend : `/api/src/presentation/api/v1/routes/auth.py`
- Database : Ajouter `phone` field dans `User` model (Prisma + SQLAlchemy)

#### B. Page de Signup (`/signup`)
```typescript
// Champs du formulaire
- Email (required)
- Phone number (optional mais recommand√©)
- Name (required)
- Password (required)
- Confirm password (required)
- Acceptation CGU/Privacy (required)
- Newsletter opt-in (optional)
```

**User Flow Signup** :
```
1. User remplit formulaire
2. Validation c√¥t√© client (Zod schema)
3. POST /api/v1/auth/signup
4. Backend cr√©e User + Org (automatique)
5. Email de v√©rification envoy√©
6. Redirection vers /onboarding
```

---

### 2Ô∏è‚É£ **ONBOARDING WIZARD OPTIMIS√â (5 √âTAPES MAX)**

**Objectif** : Time-to-First-Call < 10 minutes

#### √âtape 1 : üëã Welcome
```typescript
// Content
- Animation de bienvenue
- "Bonjour {name}, configurons votre r√©ceptionniste IA en 5 minutes"
- Pr√©visualisation du r√©sultat final (screenshot dashboard)
- CTA : "Commencer" ‚Üí Go to Step 2
```

#### √âtape 2 : üìû Phone Number Setup (CRITIQUE)

**IMPORTANT** : Vapi ne fournit de num√©ros gratuits QUE pour les US. Pour FR/IL et international, import Twilio obligatoire.

```typescript
// D√©tection automatique du pays user (bas√© sur locale ou IP)
const userCountry = detectUserCountry(); // "FR", "IL", "US", etc.

// Options propos√©es selon le pays
if (userCountry === "US") {
  // OPTION A : Num√©ro gratuit Vapi (1 clic)
  Option A : "Obtenir un num√©ro US gratuit" (Recommand√© - USA uniquement)
    ‚Üí Via Vapi /phone-numbers endpoint
    ‚Üí Gratuit (max 10 num√©ros par compte)
    ‚Üí Preview du num√©ro avant cr√©ation
    ‚Üí Setup automatique avec AVA
    
  // OPTION B : Import Twilio (pour plus de contr√¥le)
  Option B : "Importer mon num√©ro Twilio"
    ‚Üí Guide ci-dessous
    
} else {
  // FRANCE, ISRA√ãL, INTERNATIONAL : Twilio obligatoire
  Option A : "Configurer avec Twilio" (Obligatoire pour {country})
    ‚Üí Guide step-by-step d√©taill√© :
       1. Cr√©ez un compte sur twilio.com/try-twilio
       2. Achetez un num√©ro {country} (Phone Numbers ‚Üí Buy a Number)
          - France : ~1‚Ç¨/mois
          - Isra√´l : ~1.5$/mois
          - Voice capability required
       3. Copiez votre Account SID
       4. Copiez votre Auth Token  
       5. Copiez le num√©ro achet√©
       6. Collez ici ‚¨áÔ∏è
    ‚Üí AVA va :
       ‚úì Tester la connexion Twilio
       ‚úì Importer le num√©ro dans Vapi (/phone-numbers/import)
       ‚úì Configurer le webhook automatiquement
       ‚úì Lier le num√©ro √† votre assistant AVA
}

Option C : "Je configure plus tard" (Skip)
  ‚Üí Warning : "Vous ne pourrez pas recevoir d'appels"
  ‚Üí Permet de tester l'interface
```

**IMPL√âMENTATION TECHNIQUE - OPTION A (VAPI - US UNIQUEMENT)**

‚ö†Ô∏è **Limitation** : Vapi ne fournit des num√©ros gratuits QUE pour les √âtats-Unis.

```typescript
// Frontend : /webapp/components/onboarding/phone-setup-vapi.tsx
import { vapi } from '@/lib/vapi/client';

async function createFreeUSNumber(areaCode: string, orgId: string) {
  try {
    // ‚ö†Ô∏è Gratuit uniquement pour US, max 10 num√©ros par compte
    
    // 1. Create a free US number via Vapi
    const created = await vapi.phoneNumbers.create({
      // Vapi assigne automatiquement un num√©ro US disponible
      assistantId: avaAssistantId // Auto-link √† AVA
    });
    
    // 2. Save to database
    await fetch('/api/phone-numbers', {
      method: 'POST',
      body: JSON.stringify({
        orgId,
        provider: 'VAPI',
        e164: created.number, // Format E.164 : +1234567890
        vapiPhoneNumberId: created.id,
        assistantId: avaAssistantId
      })
    });
    
    return created;
  } catch (error) {
    if (error.message.includes('limit reached')) {
      // User a d√©j√† 10 num√©ros gratuits
      throw new Error('Limite de 10 num√©ros gratuits atteinte. Utilisez Twilio pour plus de num√©ros.');
    }
    throw error;
  }
}
```

**Backend API** :
```python
# /api/src/presentation/api/v1/routes/phone_numbers.py
from fastapi import APIRouter, Depends, HTTPException
from api.src.infrastructure.vapi.client import VapiClient

router = APIRouter(prefix="/phone-numbers", tags=["phone"])

@router.post("/create-us")
async def create_free_us_number(
    assistant_id: str,
    org_id: str,
    user=Depends(get_current_user)
):
    """Cr√©e un num√©ro US gratuit via Vapi (max 10 par compte)"""
    vapi = VapiClient()
    
    try:
        # Create via Vapi (US only, free, max 10)
        created = await vapi.create_phone_number(
            assistant_id=assistant_id
        )
        
        # Save to our DB
        phone = PhoneNumber(
            org_id=org_id,
            provider="VAPI",
            e164=created["number"],
            vapi_phone_number_id=created["id"],
            routing={"assistant_id": assistant_id}
        )
        db.add(phone)
        await db.commit()
        
        return {"success": True, "phone": phone}
    except Exception as e:
        if "limit" in str(e).lower():
            raise HTTPException(
                status_code=400,
                detail="Limite de 10 num√©ros gratuits atteinte. Utilisez l'import Twilio."
            )
        raise
```

**IMPL√âMENTATION TECHNIQUE - OPTION B (TWILIO + VAPI IMPORT)**

‚úÖ **Solution pour France, Isra√´l et tous les pays hors US**

Workflow :
1. User ach√®te un num√©ro sur Twilio (FR/IL/etc.)
2. User fournit credentials Twilio + num√©ro
3. AVA **importe** le num√©ro dans Vapi via `/phone-numbers/import`
4. Vapi configure automatiquement les webhooks

```typescript
// Frontend : /webapp/components/onboarding/phone-setup-twilio.tsx
async function importTwilioNumber({
  twilioAccountSid,
  twilioAuthToken,
  phoneNumber,
  assistantId,
  orgId
}: {
  twilioAccountSid: string;
  twilioAuthToken: string;
  phoneNumber: string; // Format E.164 : +33612345678 ou +972501234567
  assistantId: string;
  orgId: string;
}) {
  try {
    // 1. V√©rifier que le num√©ro existe dans Twilio
    const verifyRes = await fetch('/api/phone-numbers/twilio/verify', {
      method: 'POST',
      body: JSON.stringify({
        accountSid: twilioAccountSid,
        authToken: twilioAuthToken,
        phoneNumber
      })
    });
    
    const { valid } = await verifyRes.json();
    if (!valid) {
      throw new Error('Num√©ro non trouv√© dans votre compte Twilio');
    }
    
    // 2. Importer dans Vapi
    const importRes = await fetch('/api/phone-numbers/import-twilio', {
      method: 'POST',
      body: JSON.stringify({
        twilioAccountSid,
        twilioAuthToken,
        phoneNumber,
        assistantId,
        orgId
      })
    });
    
    const imported = await importRes.json();
    
    return imported;
  } catch (error) {
    console.error('Import failed:', error);
    throw error;
  }
}
```

**Backend API** :
```python
# /api/src/presentation/api/v1/routes/phone_numbers.py
@router.post("/import-twilio")
async def import_twilio_to_vapi(
    twilio_account_sid: str,
    twilio_auth_token: str,
    phone_number: str,
    assistant_id: str,
    org_id: str,
    user=Depends(get_current_user)
):
    """
    Importe un num√©ro Twilio dans Vapi
    
    Workflow :
    1. V√©rifie que le num√©ro existe dans Twilio
    2. Appelle Vapi /phone-numbers/import
    3. Vapi configure automatiquement le webhook Twilio ‚Üí Vapi
    4. Sauvegarde dans notre DB
    """
    from twilio.rest import Client as TwilioClient
    from api.src.infrastructure.vapi.client import VapiClient
    
    # 1. Verify Twilio number exists
    twilio = TwilioClient(twilio_account_sid, twilio_auth_token)
    
    try:
        numbers = twilio.incoming_phone_numbers.list(
            phone_number=phone_number,
            limit=1
        )
        
        if not numbers:
            raise HTTPException(
                status_code=404,
                detail=f"Num√©ro {phone_number} non trouv√© dans votre compte Twilio"
            )
    except Exception as e:
        raise HTTPException(
            status_code=400,
            detail=f"Erreur Twilio : {str(e)}"
        )
    
    # 2. Import to Vapi
    vapi = VapiClient()
    
    try:
        imported = await vapi.import_phone_number(
            twilio_account_sid=twilio_account_sid,
            twilio_auth_token=twilio_auth_token,
            phone_number=phone_number,
            assistant_id=assistant_id
        )
        
        # 3. Save to our DB
        phone = PhoneNumber(
            org_id=org_id,
            provider="VAPI",  # Managed by Vapi but uses Twilio under the hood
            e164=phone_number,
            vapi_phone_number_id=imported["id"],
            twilio_account_sid=twilio_account_sid,
            routing={"assistant_id": assistant_id}
        )
        db.add(phone)
        await db.commit()
        
        return {
            "success": True,
            "message": "Num√©ro import√© avec succ√®s dans Vapi",
            "phone": phone,
            "vapi_config": imported
        }
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"Erreur lors de l'import Vapi : {str(e)}"
        )
```

**Vapi Client Helper** :
```python
# /api/src/infrastructure/vapi/client.py
class VapiClient:
    def __init__(self):
        self.api_key = settings.vapi_api_key
        self.base_url = "https://api.vapi.ai"
    
    async def import_phone_number(
        self,
        twilio_account_sid: str,
        twilio_auth_token: str,
        phone_number: str,
        assistant_id: str
    ):
        """
        Import a Twilio number to Vapi
        
        Vapi will automatically:
        - Configure Twilio webhook to point to Vapi
        - Handle inbound calls using the specified assistant
        
        Doc: https://docs.vapi.ai/api-reference/phone-numbers/import
        """
        import httpx
        
        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.base_url}/phone-numbers/import",
                headers={
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                },
                json={
                    "twilioAccountSid": twilio_account_sid,
                    "twilioAuthToken": twilio_auth_token,
                    "number": phone_number,
                    "assistantId": assistant_id
                }
            )
            
            if response.status_code != 200:
                raise Exception(f"Vapi import failed: {response.text}")
            
            return response.json()
```
            return response.json()

---

#### √âtape 3 : üè¢ Industry & Use Case```typescript
// Frontend : /webapp/components/onboarding/phone-setup-twilio.tsx
function TwilioSetupGuide() {
  return (
    <div className="space-y-6">
      {/* Step-by-step guide avec accordions */}
      <Accordion>
        <AccordionItem value="step1">
          <AccordionTrigger>
            <span className="flex items-center gap-2">
              <CheckCircle className="h-5 w-5" />
              √âtape 1 : Cr√©er un compte Twilio
            </span>
          </AccordionTrigger>
          <AccordionContent>
            <div className="space-y-3">
              <p>1. Allez sur <a href="https://www.twilio.com/try-twilio">twilio.com/try-twilio</a></p>
              <p>2. Cr√©ez votre compte (gratuit pour commencer)</p>
              <p>3. V√©rifiez votre email</p>
              <img src="/guide/twilio-signup.png" alt="Signup Twilio" />
            </div>
          </AccordionContent>
        </AccordionItem>
        
        <AccordionItem value="step2">
          <AccordionTrigger>√âtape 2 : Acheter un num√©ro</AccordionTrigger>
          <AccordionContent>
            <p>1. Dans Twilio Console ‚Üí Phone Numbers ‚Üí Buy a Number</p>
            <p>2. Choisissez pays et r√©gion</p>
            <p>3. S√©lectionnez "Voice" capability</p>
            <p>4. Prix : ~1‚Ç¨/mois</p>
            <img src="/guide/twilio-buy-number.png" alt="Buy number" />
          </AccordionContent>
        </AccordionItem>
        
        <AccordionItem value="step3">
          <AccordionTrigger>√âtape 3 : R√©cup√©rer vos credentials</AccordionTrigger>
          <AccordionContent>
            <p>1. Twilio Console ‚Üí Account Info</p>
            <p>2. Copiez "Account SID"</p>
            <p>3. Copiez "Auth Token" (cliquez sur "show")</p>
            <img src="/guide/twilio-credentials.png" alt="Credentials" />
          </AccordionContent>
        </AccordionItem>
      </Accordion>
      
      {/* Form pour entrer les credentials */}
      <form className="space-y-4">
        <Input 
          label="Account SID" 
          placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        />
        <Input 
          label="Auth Token" 
          type="password"
          placeholder="********************************"
        />
        <Input 
          label="Phone Number" 
          placeholder="+33612345678 (France) ou +972501234567 (Isra√´l)"
        />
        <Button type="submit">Tester et Importer dans Vapi</Button>
      </form>
      
      {/* Message de succ√®s */}
      <div className="mt-4 p-4 bg-green-50 rounded">
        <p>‚úÖ Num√©ro v√©rifi√© ! AVA va maintenant l'importer dans Vapi...</p>
        <p className="text-sm text-muted-foreground">
          Vapi configurera automatiquement le webhook Twilio pour recevoir les appels.
        </p>
      </div>
    </div>
  );
}
```

**Backend pour tester la connexion Twilio** :
```python
# /api/src/presentation/api/v1/routes/phone_numbers.py
@router.post("/twilio/verify")
async def verify_twilio_credentials(
    account_sid: str,
    auth_token: str,
    phone_number: str
):
    """V√©rifie que les credentials Twilio sont valides et que le num√©ro existe"""
    try:
        from twilio.rest import Client
        client = Client(account_sid, auth_token)
        
        # Test : v√©rifie que le num√©ro existe dans ce compte
        numbers = client.incoming_phone_numbers.list(
            phone_number=phone_number,
            limit=1
        )
        
        if not numbers:
            return {"valid": False, "error": "Num√©ro non trouv√© dans votre compte Twilio"}
        
        return {
            "valid": True, 
            "number": numbers[0].phone_number,
            "country": numbers[0].iso_country  # FR, IL, US, etc.
        }
    except Exception as e:
        return {"valid": False, "error": str(e)}
```

---

### 3Ô∏è‚É£ **DASHBOARD POST-ONBOARDING**
```typescript
// Quick selection (1 clic)
const industries = [
  { id: 'health', label: 'Sant√© (m√©decins, kin√©s, dentistes)', icon: 'üè•' },
  { id: 'beauty', label: 'Beaut√© (coiffeurs, esth√©ticiennes)', icon: 'üíá' },
  { id: 'legal', label: 'Juridique (avocats, notaires)', icon: '‚öñÔ∏è' },
  { id: 'consulting', label: 'Conseil & Services', icon: 'üíº' },
  { id: 'ecommerce', label: 'E-commerce & Retail', icon: 'üõçÔ∏è' },
  { id: 'real-estate', label: 'Immobilier', icon: 'üè†' },
  { id: 'other', label: 'Autre', icon: '‚ú®' }
];

// Bas√© sur le choix, on charge un preset AVA
// Preset = prompts + rules + voice + first message
```

**Presets AVA par industrie** :
```typescript
// /webapp/lib/ava-presets.ts
export const AVA_PRESETS = {
  health: {
    name: "AVA Sant√©",
    voice: "playht-female-fr",
    firstMessage: "Bonjour, cabinet du Dr. {name}, je suis AVA votre assistante. Comment puis-je vous aider ?",
    systemPrompt: `Tu es AVA, assistante d'un cabinet m√©dical.
    - Prends les RDV avec gentillesse et professionnalisme
    - Demande : nom, pr√©nom, motif, date souhait√©e
    - Si urgence ‚Üí proposer consultation rapide
    - Ne donne JAMAIS de conseil m√©dical`,
    rules: {
      bookingEnabled: true,
      urgencyDetection: true,
      medicalAdviceBlocked: true
    }
  },
  beauty: {
    name: "AVA Beaut√©",
    voice: "playht-female-fr",
    firstMessage: "Bonjour {salon_name}, je suis AVA. Un rendez-vous coiffure ou beaut√© ?",
    systemPrompt: `Tu es AVA, assistante d'un salon de beaut√©.
    - Prends les RDV avec sourire et enthousiasme
    - Propose les prestations : coupe, couleur, soin, etc.
    - Demande les pr√©f√©rences (styliste pr√©f√©r√©)`,
    rules: {
      bookingEnabled: true,
      serviceSelection: true
    }
  }
  // ... autres presets
};
```

#### √âtape 4 : üé§ Personnalisation AVA (Optionnel)
```typescript
// Si user veut customiser
- Nom de l'assistante (d√©faut : "AVA")
- Voix (preview audio pour chaque voix)
- Ton : Professionnel | Chaleureux | Dynamique
- Message d'accueil personnalis√©
```

#### √âtape 5 : üöÄ Test Call = AHA MOMENT
```typescript
// Le moment magique
- "Testez AVA maintenant ! Appelez ce num√©ro : {phone_number}"
- Gros bouton "Appeler maintenant" (lance un appel via browser si possible)
- Pendant l'appel : animation "AVA is listening..."
- Apr√®s l'appel : 
  ‚Üí Affichage imm√©diat de la transcription
  ‚Üí "Bravo ! AVA est pr√™te. Voici votre dashboard ‚Üí"
  ‚Üí Redirection automatique vers /dashboard
```

**Impl√©mentation Test Call** :
```typescript
// Frontend : /webapp/components/onboarding/test-call.tsx
import { useVapi } from '@vapi-ai/react';

function TestCallStep({ phoneNumber, assistantId }) {
  const { start, stop, messages, isCallActive } = useVapi();
  
  const startTestCall = async () => {
    // Option 1 : Web call (si navigateur supporte)
    await start(assistantId);
    
    // Option 2 : Afficher le num√©ro √† appeler
    // User appelle avec son t√©l√©phone
  };
  
  return (
    <div className="text-center space-y-6">
      <h2>Testez AVA maintenant !</h2>
      
      {/* Si web call support√© */}
      <Button size="lg" onClick={startTestCall}>
        <Phone className="mr-2" />
        Appeler AVA depuis ce navigateur
      </Button>
      
      {/* Sinon */}
      <div className="p-6 bg-muted rounded-lg">
        <p>Appelez ce num√©ro depuis votre t√©l√©phone :</p>
        <p className="text-3xl font-bold my-4">{phoneNumber}</p>
      </div>
      
      {/* Pendant l'appel */}
      {isCallActive && (
        <div className="animate-pulse">
          <Mic className="h-16 w-16 mx-auto" />
          <p>AVA vous √©coute...</p>
        </div>
      )}
      
      {/* Apr√®s l'appel : afficher transcription en temps r√©el */}
      {messages.length > 0 && (
        <div className="text-left bg-white p-4 rounded border">
          <h3>Transcription :</h3>
          {messages.map(msg => (
            <p key={msg.id}>
              <strong>{msg.role}:</strong> {msg.content}
            </p>
          ))}
        </div>
      )}
      
      {/* CTA final */}
      <Button size="lg" onClick={() => router.push('/dashboard')}>
        Acc√©der √† mon dashboard ‚Üí
      </Button>
    </div>
  );
}
```

---

### 3Ô∏è‚É£ **DASHBOARD POST-ONBOARDING**

**Layout recommand√©** (selon DIVINE_CODEX) :
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [Logo AVA]  [Dashboard]  [Calls]  [Settings]  ‚îÇ ‚Üê Top Nav
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                 ‚îÇ
‚îÇ  üìä Quick Stats (Cards)                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ 24   ‚îÇ  ‚îÇ 18   ‚îÇ  ‚îÇ 92%  ‚îÇ  ‚îÇ 4.2  ‚îÇ       ‚îÇ
‚îÇ  ‚îÇCalls ‚îÇ  ‚îÇ RDV  ‚îÇ  ‚îÇ Rep. ‚îÇ  ‚îÇStars ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  üìû Appels r√©cents                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ [Avatar] Jean Dupont  +33612... 14:23  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚úÖ RDV pris pour lundi 10h             ‚îÇ   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ  ‚îÇ [Avatar] Marie Martin +33687... 12:15  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚ÑπÔ∏è  Question sur horaires               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  üìà Insights & Trends                           ‚îÇ
‚îÇ  [Graphique d'√©volution des appels]            ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üì¶ MOD√àLES DE DONN√âES √Ä AJOUTER/MODIFIER

### Prisma Schema Updates
```prisma
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  phone         String?  @unique  // ‚Üê NOUVEAU
  phoneVerified Boolean  @default(false)  // ‚Üê NOUVEAU
  password      String?  // ‚Üê NOUVEAU (hashed)
  name          String?
  image         String?
  locale        String   @default("en")
  twoFAEnabled  Boolean  @default(false)
  createdAt     DateTime @default(now())
  orgMemberships OrgUser[]
  
  // Tracking onboarding
  onboardingCompleted Boolean @default(false)  // ‚Üê NOUVEAU
  onboardingStep      Int     @default(0)      // ‚Üê NOUVEAU
}

model PhoneNumber {
  id                 String   @id @default(cuid())
  orgId              String
  provider           Provider // TWILIO | VAPI
  e164               String   @unique
  
  // Vapi specific
  vapiPhoneNumberId  String?  // ‚Üê NOUVEAU
  vapiAssistantId    String?  // ‚Üê NOUVEAU
  
  // Twilio specific  
  twilioAccountSid   String?  // ‚Üê NOUVEAU
  
  routing            Json
  businessHours      Json
  voicemail          Json
  calls              Call[]
  createdAt          DateTime @default(now())

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

enum Provider {
  TWILIO
  VAPI    // ‚Üê NOUVEAU
  SIP
}
```

---

## üõ†Ô∏è STACK TECHNIQUE

### Frontend
- **Pages** : `/login`, `/signup`, `/onboarding`, `/dashboard`
- **Components** :
  - `<LoginForm />` - Email OU Phone + Password/Magic Link
  - `<SignupForm />` - Formulaire complet
  - `<OnboardingWizard />` - Stepper avec 5 √©tapes
  - `<PhoneSetupVapi />` - Achat num√©ro via Vapi
  - `<PhoneSetupTwilio />` - Guide Twilio manuel
  - `<TestCall />` - Appel test avec transcription live
  - `<DashboardHome />` - Vue d'accueil post-onboarding
- **Libs** :
  - `@vapi-ai/react` - Hooks pour appels web
  - `@vapi-ai/server-sdk` - API calls serveur
  - `react-hook-form` + `zod` - Validation forms
  - `next-auth` - Session management

### Backend
- **Routes** :
  - `/api/v1/auth/signup` - Cr√©ation user
  - `/api/v1/auth/login` - Login email/phone
  - `/api/v1/auth/verify-email` - V√©rification email
  - `/api/v1/auth/verify-phone` - V√©rification SMS
  - `/api/v1/phone-numbers/available` - Liste num√©ros Vapi
  - `/api/v1/phone-numbers/purchase` - Achat via Vapi
  - `/api/v1/phone-numbers/twilio/verify` - Test credentials Twilio
  - `/api/v1/phone-numbers/twilio/setup` - Setup webhook Twilio
  - `/api/v1/onboarding/preset` - Get preset AVA par industrie
  - `/api/v1/onboarding/complete` - Marquer onboarding termin√©
- **Services** :
  - `VapiService` - Wrapper pour Vapi SDK
  - `TwilioService` - Wrapper pour Twilio SDK
  - `AuthService` - Hash password, generate tokens
  - `OnboardingService` - Logique business onboarding

---

## üìù CHECKLIST D'IMPL√âMENTATION

### Phase 1 : Auth Foundation (2-3 jours)
- [ ] Ajouter `phone`, `password` fields au User model (Prisma + migration)
- [ ] Backend : routes `/auth/signup`, `/auth/login`
- [ ] Backend : hash password (bcrypt), JWT tokens
- [ ] Frontend : page `/login` avec LoginForm
- [ ] Frontend : page `/signup` avec SignupForm
- [ ] Test : Signup ‚Üí Login ‚Üí Session active

### Phase 2 : Onboarding Wizard (3-4 jours)
- [ ] Frontend : layout `/onboarding` avec stepper
- [ ] Step 1 : Welcome screen
- [ ] Step 2 : Phone Setup (Vapi option)
- [ ] Backend : `/phone-numbers/available`, `/purchase`
- [ ] Step 2 : Phone Setup (Twilio option alternative)
- [ ] Backend : `/twilio/verify`, `/twilio/setup`
- [ ] Step 3 : Industry selection + preset loading
- [ ] Step 4 : AVA customization (voice, tone, message)
- [ ] Step 5 : Test call + transcription live
- [ ] Backend : `/onboarding/complete`
- [ ] Test : Full onboarding flow < 10 minutes

### Phase 3 : Dashboard & Polish (2 jours)
- [ ] Dashboard layout (top nav, quick stats, recent calls)
- [ ] Int√©grer donn√©es r√©elles (calls depuis DB)
- [ ] Loading states, error handling
- [ ] Responsive mobile
- [ ] Tests E2E (Playwright)

### Phase 4 : Documentation (1 jour)
- [ ] Guide utilisateur phone setup (screenshots)
- [ ] FAQ onboarding
- [ ] Vid√©o d√©mo (Loom)
- [ ] Tooltips dans l'app

---

## üé¨ USER JOURNEY COMPLET

```
1. Landing page ‚Üí "Essayer gratuitement" (CTA)
   ‚Üì
2. /signup ‚Üí Formulaire (email, phone, name, password)
   ‚Üì
3. Email de v√©rification ‚Üí Clic lien
   ‚Üì
4. /onboarding
   ‚îú‚îÄ Step 1 : Welcome (30 sec)
   ‚îú‚îÄ Step 2 : Phone Setup (2 min)
   ‚îÇ   ‚îú‚îÄ Option A : Vapi (1 clic) ‚úÖ Recommand√©
   ‚îÇ   ‚îî‚îÄ Option B : Twilio (guide 5 min)
   ‚îú‚îÄ Step 3 : Industry (30 sec)
   ‚îú‚îÄ Step 4 : Customization (1 min - optionnel)
   ‚îî‚îÄ Step 5 : Test Call ‚≠ê AHA MOMENT (2 min)
   ‚Üì
5. /dashboard ‚Üí User voit sa premi√®re transcription
   ‚Üì
6. Activation ! üéâ
```

**Temps total** : 5-10 minutes (objectif DIVINE_CODEX atteint ‚úÖ)

---

## üîê S√âCURIT√â & BONNES PRATIQUES

### Auth
- ‚úÖ Password hash avec bcrypt (cost 12)
- ‚úÖ JWT tokens avec expiration (access: 15min, refresh: 7 days)
- ‚úÖ HTTPS only en production
- ‚úÖ Rate limiting sur `/auth/*` routes (5 tentatives/minute)
- ‚úÖ Email verification obligatoire
- ‚úÖ Phone verification optionnelle (recommand√©e pour 2FA)

### Credentials Twilio
- ‚ùå JAMAIS stocker `auth_token` en clair
- ‚úÖ Encryption avec `cryptography.fernet` c√¥t√© backend
- ‚úÖ Stocker uniquement hash en DB
- ‚úÖ Use environment variables pour secrets

### Phone Numbers
- ‚úÖ Valider format E.164 (`+33612345678`)
- ‚úÖ V√©rifier unicit√© (1 num√©ro = 1 org)
- ‚úÖ Webhook signature verification (Twilio/Vapi)

---

## üìä M√âTRIQUES DE SUCC√àS

- **Time to First Call** : < 10 minutes ‚è±Ô∏è
- **Onboarding Completion Rate** : > 60% üìà
- **Phone Setup Success** : > 90% (option Vapi) üìû
- **Trial to Paid Conversion** : > 25% üí∞
- **User Satisfaction (NPS)** : > 50 üòä

---

## üöß POINTS D'ATTENTION

### 1. Vapi Phone Numbers - LIMITATION IMPORTANTE ‚ö†Ô∏è
- **Num√©ros gratuits** : US UNIQUEMENT (max 10 par compte)
- **France, Isra√´l, International** : OBLIGATOIREMENT via Twilio + import Vapi
- **Workflow recommand√©** :
  - D√©tecter le pays du user (locale/IP)
  - Si US ‚Üí Proposer num√©ro gratuit Vapi
  - Si FR/IL/autre ‚Üí Guide Twilio + import automatique
- **Documentation** : https://docs.vapi.ai/quickstart/phone-calling

### 2. Twilio ‚Üí Vapi Import
- Utiliser l'endpoint `/phone-numbers/import` de Vapi
- Vapi configure automatiquement le webhook Twilio
- User garde le billing Twilio (avantage : plus transparent)
- Credentials Twilio doivent √™tre stock√©s encrypted c√¥t√© backend

### 3. Test Call
- Fallback si browser ne supporte pas web calling
- Clear instructions pour call depuis mobile
- Timeout si user ne call pas (skip step after 5min)

### 4. Mobile Experience
- Onboarding doit √™tre 100% mobile-friendly
- Test sur iOS Safari (restrictions audio/video)
- Bouton "Call" doit ouvrir l'app t√©l√©phone native

---

## üíé NEXT STEPS

1. **Review ce plan** avec l'√©quipe
2. **Cr√©er les issues GitHub** (1 issue = 1 checkbox)
3. **Commencer par Phase 1** (Auth Foundation)
4. **Iterate fast** : Ship onboarding v1 en 1 semaine
5. **Mesurer** : Analytics sur chaque step de l'onboarding
6. **Optimiser** : A/B test sur les CTA, wording, order des steps

---

**Ready to build ? Let's make AVA DIVINE ! üöÄ**
